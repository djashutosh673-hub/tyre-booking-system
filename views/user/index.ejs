<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Book Tyre Service</title>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&libraries=places"></script>

<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI'; }
body { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
.container { background:white; border-radius:10px; box-shadow:0 15px 35px rgba(0,0,0,0.2); padding:40px; width:100%; max-width:600px; }
h1 { color:#333; margin-bottom:30px; text-align:center; }
.form-group { margin-bottom:20px; }
label { display:block; margin-bottom:8px; color:#555; font-weight:600; }
input { width:100%; padding:12px 15px; border:2px solid #e0e0e0; border-radius:6px; }
.form-row { display:flex; gap:15px; }
.half { flex:1; }
button { background:#667eea; color:white; border:none; padding:14px; font-size:18px; border-radius:6px; width:100%; cursor:pointer; }
#map { height:250px; margin-top:15px; border-radius:8px; border:2px solid #e0e0e0; }
.location-note { text-align:center; margin-top:8px; font-size:13px; color:#666; }
</style>
</head>

<body>

<div class="container">

<h1>üöó Book Tyre Service</h1>

<form id="bookingForm">

<div class="form-group">
<label>Full Name *</label>
<input type="text" name="userName" required>
</div>

<div class="form-group">
<label>Phone Number *</label>
<input type="tel" name="userPhone" required>
</div>

<div class="form-group">
<label>Vehicle Number</label>
<input type="text" name="vehicleNumber">
</div>

<div class="form-group">
<label>Tyre Service / Brand *</label>
<input type="text" name="service" required>
</div>

<div class="form-row">
<div class="form-group half">
<label>Preferred Date *</label>
<input type="date" name="bookingDate" id="bookingDate" required>
</div>

<div class="form-group half">
<label>Preferred Time *</label>
<input type="time" name="bookingTime" required>
</div>
</div>

<input type="hidden" name="lat" id="lat">
<input type="hidden" name="lng" id="lng">

<div id="map"></div>
<div class="location-note">üìç Drag marker to set location</div>

<button type="submit">üìÖ Book Now</button>

</form>

</div>

<script>

// Set today as minimum date
const today = new Date().toISOString().split('T')[0];
document.getElementById('bookingDate').setAttribute('min', today);

// GOOGLE MAPS
let map, marker;

const defaultLat = 19.0760;
const defaultLng = 72.8777;

function initMap(lat,lng){

const location = {lat,lng};

map = new google.maps.Map(document.getElementById('map'),{
center:location,
zoom:13
});

marker = new google.maps.Marker({
position:location,
map:map,
draggable:true,
animation: google.maps.Animation.DROP
});

google.maps.event.addListener(marker,'dragend',function(){

const pos = marker.getPosition();

document.getElementById('lat').value = pos.lat();
document.getElementById('lng').value = pos.lng();

});

document.getElementById('lat').value = lat;
document.getElementById('lng').value = lng;

}

// get user location
if(navigator.geolocation){

navigator.geolocation.getCurrentPosition(

pos=>initMap(pos.coords.latitude,pos.coords.longitude),

()=>initMap(defaultLat,defaultLng)

);

}else{

initMap(defaultLat,defaultLng);

}

// FORM SUBMIT
document.getElementById('bookingForm').addEventListener('submit', async (e)=>{

e.preventDefault();

const formData = new FormData(e.target);
const data = Object.fromEntries(formData.entries());

if(!data.lat || !data.lng){

alert('‚ùå Please wait for map and set location.');
return;

}

try{

const response = await fetch('/create-booking',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify(data)
});

const result = await response.json();

if(response.ok && result.success){

alert(`‚úÖ Booking created! Redirecting to tracking...`);

// ‚≠ê AUTO REDIRECT (IMPORTANT)
window.location.href = "/track/" + result.bookingId;

}else{

alert('‚ùå Error: ' + (result.error || 'Unknown error'));

}

}catch(err){

console.error(err);
alert('‚ùå Network error');

}

});

</script>

</body>
</html>
